version: '3.8'

services:
  # Mock upstream server
  upstream:
    build:
      context: .
      dockerfile: docker/Dockerfile.upstream
    ports:
      - "3001:3001"
    networks:
      - gateway-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Schema Gateway
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      - ./examples:/app/config:ro
      - ./examples/schemas:/app/schemas:ro
    environment:
      - RUST_LOG=info
    depends_on:
      upstream:
        condition: service_healthy
    networks:
      - gateway-net
    command: ["--config", "/app/config/demo-config.yml", "--port", "8080"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Load testing with wrk
  wrk-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.wrk
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - gateway-net
    volumes:
      - ./docker/wrk-scripts:/scripts:ro
    profiles:
      - testing

  # Load testing with k6
  k6-test:
    image: grafana/k6:latest
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - gateway-net
    volumes:
      - ./docker/k6-scripts:/scripts:ro
    command: run /scripts/load-test.js
    profiles:
      - testing

  # Memory profiling
  valgrind:
    build:
      context: .
      dockerfile: docker/Dockerfile.valgrind
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - gateway-net
    privileged: true
    profiles:
      - profiling

networks:
  gateway-net:
    driver: bridge

